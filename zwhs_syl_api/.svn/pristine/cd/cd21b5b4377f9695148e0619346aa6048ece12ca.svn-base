package cn.org.citycloud.zwhs.syl.service;
import java.util.List;

import javax.persistence.criteria.CriteriaBuilder;
import javax.persistence.criteria.CriteriaQuery;
import javax.persistence.criteria.Path;
import javax.persistence.criteria.Predicate;
import javax.persistence.criteria.Root;

import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;

import cn.org.citycloud.zwhs.syl.entity.Store;
import cn.org.citycloud.zwhs.syl.repository.StoreDao;

/**
 * 
 * @author Allen
 *
 */

//Spring Bean的标识.
@Component
// 类中所有public函数都纳入事务管理的标识.
@Transactional
public class StoreService {
	@Autowired
	private StoreDao storeDao;
	
	/**
	 * 动态查询店铺列表
	 * @param pageable
	 * @param goodsCommon
	 * @return
	 */
	public Page<Store> getStorePage(Pageable pageable, Store store){
		
		Page<Store> page = storeDao.findAll(new Specification<Store>() {
			@Override
			public Predicate toPredicate(Root<Store> root, CriteriaQuery<?> query, CriteriaBuilder cb) {
				
				Predicate where = cb.conjunction();  
				if(store != null && StringUtils.isNotBlank(store.getCompanyName())){
					Path<String> companyName = root.get("companyName");  
					where = cb.and(where, cb.like(companyName, "%"+store.getCompanyName()+"%"));
					
				}
				if(store != null && store.getStoreState() != null){
					Path<String> storeState = root.get("storeState");  
					where = cb.and(where, cb.equal(storeState, store.getStoreState())); 
					
				}else{
					Path<String> storeState = root.get("storeState");
					where = cb.and(where, cb.notEqual(storeState, 2));
				}
				if(store != null && StringUtils.isNotBlank(store.getRegionProv())){
					Path<String> regionProv = root.get("regionProv");  
					String regionCode = store.getRegionProv().substring(0, 2);
					where = cb.and(where, cb.like(regionProv, regionCode+"%"));
					
				}
				if(store != null && StringUtils.isNotBlank(store.getRegionCity())){
					Path<String> regionCity = root.get("regionCity");  
					String regionCode = store.getRegionCity().substring(0, 4);
					where = cb.and(where, cb.like(regionCity, regionCode+"%"));
					
				}
				if(store != null && StringUtils.isNotBlank(store.getCompanyRegion())){
					Path<String> companyRegion = root.get("companyRegion");  
					where = cb.and(where, cb.like(companyRegion, "%"+store.getCompanyRegion()+"%"));
				}
				query.where(where);
				  
			    return null;   
			}
		}, pageable);
		
	    return page;
	}
	
	
	/**
	 * 动态查询店铺列表
	 * @param store
	 * @return
	 */
	public List<Store> getStoreList(Store store){
		
		List<Store> list = storeDao.findAll(new Specification<Store>() {
			@Override
			public Predicate toPredicate(Root<Store> root, CriteriaQuery<?> query, CriteriaBuilder cb) {
				
				Predicate where = cb.conjunction();  
				if(store != null && StringUtils.isNotBlank(store.getCompanyName())){
					Path<String> companyName = root.get("companyName");  
					where = cb.and(where, cb.like(companyName, "%"+store.getCompanyName()+"%"));
					
				}
				if(store != null && store.getStoreState() != null){
					Path<String> storeState = root.get("storeState");  
					where = cb.and(where, cb.equal(storeState, store.getStoreState())); 
					
				}else{
					Path<String> storeState = root.get("storeState");
					where = cb.and(where, cb.notEqual(storeState, 2));
				}
				if(store != null && StringUtils.isNotBlank(store.getRegionProv())){
					Path<String> regionProv = root.get("regionProv");  
					String regionCode = store.getRegionProv().substring(0, 2);
					where = cb.and(where, cb.like(regionProv, regionCode+"%"));
					
				}
				if(store != null && StringUtils.isNotBlank(store.getRegionCity())){
					Path<String> regionCity = root.get("regionCity");  
					String regionCode = store.getRegionCity().substring(0, 4);
					where = cb.and(where, cb.like(regionCity, regionCode+"%"));
					
				}
				if(store != null && StringUtils.isNotBlank(store.getCompanyRegion())){
					Path<String> companyRegion = root.get("companyRegion");  
					where = cb.and(where, cb.like(companyRegion, "%"+store.getCompanyRegion()+"%"));
				}
				query.where(where);
				  
			    return null;   
			}
		});
		
	    return list;
	}
	
	
	/**
	 * 根据店铺id查询店铺信息
	 * @param storeId
	 * @return
	 */
	public Store getStoreByStoreId(Integer storeId){
		
		return storeDao.findOne(storeId);
	}
	
	/**
	 * 根据店铺id修改店铺信息
	 * @param storeId
	 * @param store
	 * @return
	 */
	public Store modifyStoreByInfo(Integer storeId, Store store){
		
		Store storeupdate = storeDao.findOne(storeId);
		if(store != null && StringUtils.isNotBlank(store.getCompanyName())){
			storeupdate.setCompanyName(store.getCompanyName());
		}
		if(store != null && StringUtils.isNotBlank(store.getCompanyAddress())){
			storeupdate.setCompanyAddress(store.getCompanyAddress());
		}
		if(store != null && store.getStoreState() != null){
			storeupdate.setStoreState(store.getStoreState());
		}
		if(store != null && store.getSgId() != null){
			storeupdate.setSgId(store.getSgId());
		}
		if(store != null && store.getCommisRates() != null){
			storeupdate.setCommisRates(store.getCommisRates());
		}
		if(store != null && StringUtils.isNotBlank(store.getRegionProv())){
			storeupdate.setRegionProv(store.getRegionProv());
		}
		if(store != null && StringUtils.isNotBlank(store.getRegionCity())){
			storeupdate.setRegionCity(store.getRegionCity());
		}
		if(store != null && StringUtils.isNotBlank(store.getCompanyRegion())){
			storeupdate.setCompanyRegion(store.getCompanyRegion());
		}
		
		return storeDao.save(storeupdate);
	}
	
	
	/**
	 * 修改店铺状态
	 * @param storeId
	 * @param store
	 * @return
	 */
	public Store modifyStoreByState(Integer storeId, Store store){
		
		Store storeupdate = storeDao.findOne(storeId);
		
		if(store != null && store.getStoreState() != null){
			storeupdate.setStoreState(store.getStoreState());
		}
		if(store != null && store.getUpdDate() != null){
			storeupdate.setUpdDate(store.getUpdDate());
		}
		
		return storeDao.save(storeupdate);
	}
	
	
	/**
	 * 根据sgid修改分成比例
	 * @param commisRates
	 * @param sgId
	 */
	public void modifyStoreBySgId(Double commisRates, Integer sgId){
		
		storeDao.updateStoreCommisBySgId(commisRates, sgId);
	}
	
	
	public Long getStoreByUncheck(){
		
		return storeDao.findStoreByUncheck();
	}
	
}
